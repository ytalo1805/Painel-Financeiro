<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financeiro | Italo Fernando</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }
        .status-badge { 
            padding: 0.25rem 0.75rem; 
            border-radius: 9999px; 
            font-size: 0.75rem; 
            font-weight: 600; 
            text-transform: uppercase; 
            letter-spacing: 0.05em;
            white-space: nowrap; /* Fix for line break */
        }
        .status-pago { background-color: #dcfce7; color: #16a34a; } /* green */
        .status-em-dia { background-color: #fef9c3; color: #ca8a04; } /* yellow */
        .status-atrasado { background-color: #fee2e2; color: #dc2626; } /* red */
        
        .form-input, .btn {
            transition: all 0.2s ease-in-out;
        }
        .form-input:focus { 
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3); /* blue-500 with opacity */
            border-color: #3b82f6; /* blue-500 */
        }
        .btn-primary { 
            background-color: #2563eb; /* blue-600 */
            box-shadow: 0 1px 3px 0 rgba(0,0,0,.1), 0 1px 2px -1px rgba(0,0,0,.1);
        }
        .btn-primary:hover { 
            background-color: #1d4ed8; /* blue-700 */
            box-shadow: 0 4px 6px -1px rgba(0,0,0,.1), 0 2px 4px -2px rgba(0,0,0,.1);
        }
        
        .category-group-header th { font-size: 1rem; font-weight: 600; padding: 1rem; letter-spacing: 0.025em;}
        .debt-row { border-left-width: 4px; }
        
        #mini-calendar { width: 300px; }
        #mini-calendar .day { position: relative; }
        #mini-calendar .due-date-marker {
            position: absolute;
            bottom: 4px; left: 50%;
            transform: translateX(-50%);
            width: 5px; height: 5px;
            border-radius: 50%;
            background-color: #ef4444; /* red-500 */
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .collapsible-content.expanded { max-height: 1000px; }
        .collapsible-trigger .chevron { transition: transform 0.3s ease-out; }
        .collapsible-trigger.expanded .chevron { transform: rotate(180deg); }
        
        .header-title {
            background: linear-gradient(to right, #3b82f6, #1e40af);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .card {
            background-color: white;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0,0,0,.1), 0 2px 4px -2px rgba(0,0,0,.1); /* shadow-md */
        }
    </style>
</head>
<body class="text-slate-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">

        <header class="mb-10 flex flex-col md:flex-row justify-between items-center gap-8">
            <div class="text-center md:text-left">
                <h1 class="text-4xl md:text-5xl font-extrabold header-title">Painel Financeiro</h1>
                <p class="text-slate-500 mt-3 text-lg">Bem-vindo, Italo Fernando.</p>
            </div>
            
            <div id="mini-calendar" class="card p-4">
                <div class="flex justify-between items-center mb-2">
                    <button id="prev-month" class="text-slate-500 hover:text-slate-800"><i class="fas fa-chevron-left"></i></button>
                    <h3 id="month-year" class="font-bold text-slate-800"></h3>
                    <button id="next-month" class="text-slate-500 hover:text-slate-800"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="grid grid-cols-7 text-center text-xs text-slate-500 mb-2">
                    <span>Dom</span><span>Seg</span><span>Ter</span><span>Qua</span><span>Qui</span><span>Sex</span><span>Sáb</span>
                </div>
                <div id="calendar-days" class="grid grid-cols-7 text-center text-sm"></div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">

            <div class="lg:col-span-1 flex flex-col gap-10">
                <div class="card p-6">
                    <h2 class="text-2xl font-semibold mb-5 text-slate-800 border-b pb-3">Adicionar Nova Dívida</h2>
                    <form id="add-debt-form" class="space-y-4">
                        <div>
                            <label for="debt-name" class="block text-sm font-medium text-slate-600 mb-1">Nome da Dívida</label>
                            <input type="text" id="debt-name" placeholder="Ex: Fatura do Cartão" class="p-2 border rounded-md w-full form-input border-slate-300" required>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <label for="debt-category" class="block text-sm font-medium text-slate-600">Categoria</label>
                                <button type="button" id="manage-categories-btn" class="text-xs text-blue-600 hover:text-blue-800 font-semibold flex items-center gap-1">
                                    <i class="fas fa-cog"></i> Gerenciar
                                </button>
                            </div>
                            <select id="debt-category" class="p-2 border rounded-md w-full form-input border-slate-300" required></select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                             <div>
                               <label for="debt-type" class="block text-sm font-medium text-slate-600 mb-1">Tipo</label>
                                <select id="debt-type" class="p-2 border rounded-md w-full form-input border-slate-300" required>
                                    <option value="Variável">Variável</option>
                                    <option value="Fixa">Fixa</option>
                                </select>
                            </div>
                            <div>
                                <label for="debt-due-date" class="block text-sm font-medium text-slate-600 mb-1">Vencimento</label>
                                <input type="date" id="debt-due-date" class="p-2 border rounded-md w-full form-input border-slate-300 text-slate-500" required>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="debt-total" class="block text-sm font-medium text-slate-600 mb-1">Valor Total</label>
                                <input type="number" id="debt-total" placeholder="R$ 1200,00" class="p-2 border rounded-md w-full form-input border-slate-300" required step="0.01">
                            </div>
                            <div>
                                <label for="debt-installments" class="block text-sm font-medium text-slate-600 mb-1">Nº de Parcelas</label>
                                <input type="number" id="debt-installments" placeholder="1" value="1" min="1" class="p-2 border rounded-md w-full form-input border-slate-300" required>
                            </div>
                        </div>
                        <div class="flex items-center justify-center bg-slate-50 p-2 rounded-md">
                            <input type="checkbox" id="debt-recurrent" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <label for="debt-recurrent" class="ml-2 block text-sm font-medium text-slate-700">Dívida recorrente (assinatura)</label>
                        </div>
                        <div class="pt-2">
                            <button type="submit" class="w-full btn btn-primary text-white font-semibold p-3 rounded-md">
                                <i class="fas fa-plus mr-2"></i>Adicionar Dívida
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="lg:col-span-2 flex flex-col gap-10">
                <div class="card overflow-hidden">
                    <div class="p-4 bg-slate-50/50 border-b border-slate-200 flex justify-between items-center flex-wrap gap-2">
                        <h2 class="text-2xl font-semibold text-slate-800">Painel de Dívidas</h2>
                        <div class="flex items-center gap-2">
                             <button id="add-all-to-calendar-btn" class="text-sm bg-sky-100 text-sky-700 font-semibold px-3 py-2 rounded-md hover:bg-sky-200 transition-colors btn">
                               <i class="fas fa-calendar-check mr-1"></i>Agenda
                            </button>
                            <button id="import-data-btn" class="text-sm bg-green-100 text-green-700 font-semibold px-3 py-2 rounded-md hover:bg-green-200 transition-colors btn">
                               <i class="fas fa-upload mr-1"></i>Importar
                            </button>
                             <button id="export-data-btn" class="text-sm bg-indigo-100 text-indigo-700 font-semibold px-3 py-2 rounded-md hover:bg-indigo-200 transition-colors btn">
                               <i class="fas fa-download mr-1"></i>Exportar
                            </button>
                             <input type="file" id="import-file-input" class="hidden" accept=".json">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50/50 border-b border-slate-200">
                                <tr>
                                    <th class="p-4 text-xs font-semibold text-slate-500 uppercase tracking-wider">Dívida</th>
                                    <th class="p-4 text-xs font-semibold text-slate-500 uppercase tracking-wider text-right">Valor da Parcela</th>
                                    <th class="p-4 text-xs font-semibold text-slate-500 uppercase tracking-wider text-right">Valor Restante</th>
                                    <th class="p-4 text-xs font-semibold text-slate-500 uppercase tracking-wider">Próx. Vencimento</th>
                                    <th class="p-4 text-xs font-semibold text-slate-500 uppercase tracking-wider">Status</th>
                                    <th class="p-4 text-xs font-semibold text-slate-500 uppercase tracking-wider text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="debt-table-body" class="divide-y divide-slate-200"></tbody>
                        </table>
                    </div>
                    <div class="bg-slate-100/80 font-semibold p-4 grid grid-cols-2 md:grid-cols-3 gap-4 text-slate-600 text-sm">
                        <div>Total a Pagar: <span id="total-amount" class="block text-slate-800 text-lg font-bold">R$ 0,00</span></div>
                        <div>Total Pago: <span id="total-paid" class="block text-green-600 text-lg font-bold">R$ 0,00</span></div>
                        <div class="text-red-600">Total Restante: <span id="total-remaining" class="block text-lg font-bold">R$ 0,00</span></div>
                    </div>
                </div>

                <div class="card overflow-hidden">
                     <div id="investment-trigger" class="collapsible-trigger p-4 bg-slate-50/50 border-b border-slate-200 cursor-pointer flex justify-between items-center">
                        <h2 class="text-2xl font-semibold text-slate-800">Painel de Investimentos</h2>
                        <i class="fas fa-chevron-down chevron"></i>
                    </div>
                    <div id="investment-content" class="collapsible-content">
                        <div class="p-6">
                            <h3 class="text-xl font-semibold mb-5 text-slate-800 border-b pb-3">Adicionar Investimento</h3>
                            <form id="add-investment-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div class="sm:col-span-2"><label for="inv-name" class="block text-sm font-medium text-slate-600 mb-1">Nome do Ativo</label><input type="text" id="inv-name" placeholder="Ex: Tesouro Selic" class="p-2 border rounded-md w-full form-input border-slate-300" required></div>
                                <div><label for="inv-type" class="block text-sm font-medium text-slate-600 mb-1">Tipo</label><input type="text" id="inv-type" placeholder="Ex: Renda Fixa" class="p-2 border rounded-md w-full form-input border-slate-300" required></div>
                                <div><label for="inv-amount" class="block text-sm font-medium text-slate-600 mb-1">Valor Aportado</label><input type="number" id="inv-amount" placeholder="R$ 0,00" class="p-2 border rounded-md w-full form-input border-slate-300" required step="0.01"></div>
                                <div class="sm:col-span-2"><label for="inv-date" class="block text-sm font-medium text-slate-600 mb-1">Data de Aporte</label><input type="date" id="inv-date" class="p-2 border rounded-md w-full form-input border-slate-300 text-slate-500" required></div>
                                <div class="sm:col-span-2 mt-2"><button type="submit" class="w-full btn btn-primary text-white font-semibold p-3 rounded-md"><i class="fas fa-chart-line mr-2"></i>Adicionar Investimento</button></div>
                            </form>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-slate-50/50 border-b border-slate-200">
                                    <tr>
                                        <th class="p-4 text-xs font-semibold text-slate-500 uppercase tracking-wider">Ativo</th>
                                        <th class="p-4 text-xs font-semibold text-slate-500 uppercase tracking-wider">Data Aporte</th>
                                        <th class="p-4 text-xs font-semibold text-slate-500 uppercase tracking-wider text-right">Rend. Diário</th>
                                        <th class="p-4 text-xs font-semibold text-slate-500 uppercase tracking-wider text-right">Rend. Mensal</th>
                                        <th class="p-4 text-xs font-semibold text-slate-500 uppercase tracking-wider text-right">Valor Atualizado</th>
                                        <th class="p-4 text-xs font-semibold text-slate-500 uppercase tracking-wider text-center">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="investment-table-body" class="divide-y divide-slate-200"></tbody>
                            </table>
                        </div>
                         <div class="bg-slate-100/80 font-semibold p-4 grid grid-cols-2 gap-4 text-slate-600 text-sm">
                            <div>Total Aportado: <span id="total-invested" class="block text-slate-800 text-lg font-bold">R$ 0,00</span></div>
                            <div class="text-green-600">Valor Atual: <span id="total-updated-invested" class="block text-lg font-bold">R$ 0,00</span></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
    
    <div id="modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 id="modal-title" class="text-xl font-bold text-slate-800"></h3>
                <button id="modal-close-btn" class="text-3xl leading-none text-slate-500 hover:text-slate-800">&times;</button>
            </div>
            <div id="modal-content" class="text-slate-600"></div>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', function () {
    let categories, debts, investments;
    let calendarDate = new Date();

    const CDI_ANNUAL_RATE = 0.1040;
    const CDI_DAILY_RATE = Math.pow(1 + CDI_ANNUAL_RATE, 1/252) - 1;

    const debtForm = document.getElementById('add-debt-form'), debtTableBody = document.getElementById('debt-table-body');
    const categorySelect = document.getElementById('debt-category');
    const invForm = document.getElementById('add-investment-form'), invTableBody = document.getElementById('investment-table-body');
    const totalInvestedEl = document.getElementById('total-invested'), totalUpdatedInvestedEl = document.getElementById('total-updated-invested');
    const totalAmountEl = document.getElementById('total-amount'), totalPaidEl = document.getElementById('total-paid'), totalRemainingEl = document.getElementById('total-remaining');
    const monthYearEl = document.getElementById('month-year'), calendarDaysEl = document.getElementById('calendar-days'), prevMonthBtn = document.getElementById('prev-month'), nextMonthBtn = document.getElementById('next-month');
    const modal = document.getElementById('modal'), modalTitle = document.getElementById('modal-title'), modalContent = document.getElementById('modal-content');

    const formatCurrency = (value) => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    const formatDate = (dateString) => dateString ? new Date(dateString + 'T00:00:00').toLocaleDateString('pt-BR') : '—';
    const calculateBusinessDays = (startDate, endDate) => {
        let count = 0; const curDate = new Date(startDate.getTime());
        while (curDate <= endDate) { const dayOfWeek = curDate.getDay(); if (dayOfWeek !== 0 && dayOfWeek !== 6) count++; curDate.setDate(curDate.getDate() + 1); }
        return count;
    };
    
    // --- Data Persistence ---
    function saveData() {
        const appData = { categories, debts, investments };
        localStorage.setItem('financeiroAppData', JSON.stringify(appData));
    }

    function loadData() {
        const savedData = localStorage.getItem('financeiroAppData');
        if (savedData) {
            const appData = JSON.parse(savedData);
            categories = appData.categories;
            debts = appData.debts;
            investments = appData.investments;
        } else {
            // Default data if nothing is saved
            categories = [
                { name: 'Casa', color: '#3b82f6', icon: 'fa-home' }, { name: 'Carro', color: '#ef4444', icon: 'fa-car' },
                { name: 'Cartão de Crédito', color: '#f97316', icon: 'fa-credit-card' }, { name: 'Educação', color: '#8b5cf6', icon: 'fa-graduation-cap' },
                { name: 'Saúde', color: '#10b981', icon: 'fa-heart-pulse' }, { name: 'Lazer', color: '#ec4899', icon: 'fa-film' },
                { name: 'Outros', color: '#64748b', icon: 'fa-receipt' },
            ];
            debts = [];
            investments = [];
        }
    }


    const openModal = (title, content) => { modalTitle.innerHTML = title; modalContent.innerHTML = content; modal.classList.remove('hidden'); };
    const closeModal = () => modal.classList.add('hidden');
    
    document.querySelectorAll('.collapsible-trigger').forEach(trigger => {
        trigger.addEventListener('click', () => {
            const content = document.getElementById(trigger.id.replace('-trigger', '-content'));
            content.classList.toggle('expanded');
            trigger.classList.toggle('expanded');
        });
    });

    function renderCalendar() {
        calendarDaysEl.innerHTML = '';
        const year = calendarDate.getFullYear(), month = calendarDate.getMonth();
        monthYearEl.textContent = `${calendarDate.toLocaleString('pt-BR', { month: 'long' })} ${year}`;
        const firstDay = new Date(year, month, 1).getDay(), daysInMonth = new Date(year, month + 1, 0).getDate();
        const dueDates = debts.filter(d => d.installmentsPaid < d.installmentsTotal).map(d => d.dueDate.split('T')[0]);
        for (let i = 0; i < firstDay; i++) calendarDaysEl.insertAdjacentHTML('beforeend', '<div></div>');
        for (let day = 1; day <= daysInMonth; day++) {
            const dayStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const isToday = new Date().toDateString() === new Date(year, month, day).toDateString();
            calendarDaysEl.insertAdjacentHTML('beforeend', `<div class="day p-1 ${isToday ? 'bg-blue-500 text-white rounded-full' : ''}">${day}${dueDates.includes(dayStr) ? '<div class="due-date-marker"></div>' : ''}</div>`);
        }
    }
    prevMonthBtn.addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() - 1); renderCalendar(); });
    nextMonthBtn.addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() + 1); renderCalendar(); });
    
    function renderCategorySelect() {
        categorySelect.innerHTML = '';
        categories.forEach(cat => {
            categorySelect.insertAdjacentHTML('beforeend', `<option value="${cat.name}">${cat.name}</option>`);
        });
    }

    function renderCategoryManagerInModal() {
        const managerDiv = document.getElementById('category-manager-modal');
        if (!managerDiv) return;
        managerDiv.innerHTML = '';
        categories.forEach(cat => {
            managerDiv.insertAdjacentHTML('beforeend', `<div class="flex items-center justify-between gap-3 p-2 rounded-lg hover:bg-slate-50"><div class="flex items-center gap-3"><input type="color" value="${cat.color}" data-name="${cat.name}" class="category-color-input w-8 h-8 p-0 border-0 rounded-md cursor-pointer"><i class="fas ${cat.icon} fa-fw text-lg" style="color: ${cat.color};"></i><span class="font-medium text-slate-700">${cat.name}</span></div><button class="delete-category-btn text-slate-400 hover:text-red-500" data-name="${cat.name}"><i class="fas fa-trash-alt"></i></button></div>`);
        });
    }
    
    document.getElementById('manage-categories-btn').addEventListener('click', () => {
        const modalHTML = `
            <div class="space-y-4">
                <div id="category-manager-modal" class="space-y-2 max-h-60 overflow-y-auto pr-2"></div>
                <div class="pt-4 border-t">
                    <h4 class="font-semibold text-slate-700 mb-3">Nova Categoria</h4>
                    <form id="add-category-form-modal" class="grid grid-cols-1 sm:grid-cols-3 gap-2 items-center">
                        <input type="text" id="new-cat-name-modal" placeholder="Nome" class="p-2 border rounded-md w-full form-input border-slate-300 sm:col-span-1" required>
                        <input type="text" id="new-cat-icon-modal" placeholder="Ícone (ex: fa-car)" class="p-2 border rounded-md w-full form-input border-slate-300 sm:col-span-1" required>
                        <button type="submit" class="w-full text-sm bg-blue-500 text-white font-semibold p-2 rounded-md hover:bg-blue-600 btn sm:col-span-1">Adicionar</button>
                    </form>
                </div>
            </div>`;
        openModal('Gerenciar Categorias', modalHTML);
        renderCategoryManagerInModal();
    });

    const getStatus = (debt) => {
        if (debt.installmentsPaid >= debt.installmentsTotal) return { text: 'Finalizado', class: 'status-pago' };
        const today = new Date(); today.setHours(0,0,0,0);
        return new Date(debt.dueDate + 'T00:00:00') < today ? { text: 'Atrasado', class: 'status-atrasado' } : { text: 'Em Dia', class: 'status-em-dia' };
    };

    function renderDebts() {
        debtTableBody.innerHTML = '';
        const groupedDebts = debts.reduce((acc, debt) => { (acc[debt.category] = acc[debt.category] || []).push(debt); return acc; }, {});
        const sortedCategories = Object.keys(groupedDebts).sort();
        if (debts.length === 0) { debtTableBody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-slate-500">Nenhuma dívida cadastrada ainda.</td></tr>`; }
        
        sortedCategories.forEach(categoryName => {
            const category = categories.find(c => c.name === categoryName) || { name: categoryName, color: '#64748b', icon: 'fa-receipt' };
            debtTableBody.insertAdjacentHTML('beforeend', `<tr class="bg-slate-100/80 category-group-header"><th colspan="6" style="color: ${category.color};"><i class="fas ${category.icon} fa-fw mr-3"></i>${category.name}</th></tr>`);
            
            groupedDebts[categoryName].sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate)).forEach(debt => {
                const installmentValue = debt.total / debt.installmentsTotal;
                const remainingValue = debt.total - (debt.installmentsPaid * installmentValue);
                const isPaidOff = debt.installmentsPaid >= debt.installmentsTotal;
                const status = getStatus(debt);
                const calendarLink = `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(`Vencimento: ${debt.name}`)}&dates=${debt.dueDate.replace(/-/g, '')}/${debt.dueDate.replace(/-/g, '')}`;
                
                const rowHTML = `
                    <td class="p-4">
                        <div class="font-medium text-slate-800 flex items-center">${debt.name} ${debt.isRecurrent ? '<i class="fas fa-sync-alt ml-2 text-xs text-slate-400" title="Dívida Recorrente"></i>' : ''}</div>
                        <div class="text-sm text-slate-500">${debt.type} | ${isPaidOff ? 'Finalizado' : `Parcela ${debt.installmentsPaid + 1} de ${debt.installmentsTotal}`}</div>
                    </td>
                    <td class="p-4 text-slate-600 text-right">${formatCurrency(installmentValue)}</td>
                    <td class="p-4 font-semibold text-red-600 text-right">${formatCurrency(remainingValue)}</td>
                    <td class="p-4 text-slate-600">${isPaidOff ? '—' : formatDate(debt.dueDate)}</td>
                    <td class="p-4"><span class="status-badge ${status.class}">${status.text}</span></td>
                    <td class="p-4 text-center whitespace-nowrap">
                         <button class="text-green-500 hover:text-green-700 mr-3 pay-installment-btn" data-id="${debt.id}" title="Pagar Parcela" ${isPaidOff ? 'disabled' : ''} style="${isPaidOff ? 'opacity: 0.3; cursor: not-allowed;' : ''}"><i class="fas fa-circle-check fa-lg"></i></button>
                         <a href="${calendarLink}" target="_blank" class="text-sky-600 hover:text-sky-800 mr-3 ${isPaidOff ? 'hidden' : ''}" title="Adicionar à Agenda"><i class="fas fa-calendar-plus fa-lg"></i></a>
                         <button class="text-red-500 hover:text-red-700 delete-btn" data-id="${debt.id}" title="Excluir Dívida" data-type="debt"><i class="fas fa-trash-alt fa-lg"></i></button>
                    </td>`;
                debtTableBody.insertAdjacentHTML('beforeend', `<tr class="debt-row hover:bg-slate-50" style="border-color: ${category.color};">${rowHTML}</tr>`);
            });
        });
        updateDebtTotals(); renderCalendar();
    }
    
    const updateDebtTotals = () => {
        const totalAmount = debts.reduce((s, d) => s + d.total, 0);
        const totalPaid = debts.reduce((s, d) => s + (d.total / d.installmentsTotal * d.installmentsPaid), 0);
        totalAmountEl.textContent = formatCurrency(totalAmount); 
        totalPaidEl.textContent = formatCurrency(totalPaid);
        totalRemainingEl.textContent = formatCurrency(totalAmount - totalPaid);
    };

    function handlePaidRecurrentDebt(paidDebt) {
        const dueDate = new Date(paidDebt.dueDate + 'T00:00:00');
        dueDate.setMonth(dueDate.getMonth() + 1);
        const originalDay = new Date(paidDebt.dueDate + 'T00:00:00').getDate();
        if (dueDate.getDate() !== originalDay) { dueDate.setDate(0); }
        const newDebt = { ...paidDebt, id: Date.now(), installmentsPaid: 0, dueDate: dueDate.toISOString().split('T')[0] };
        debts.push(newDebt);
    }

    debtForm.addEventListener('submit', (e) => {
        e.preventDefault(); const form = e.target;
        debts.push({ 
            id: Date.now(), 
            name: form['debt-name'].value, 
            type: form['debt-type'].value, 
            category: form['debt-category'].value, 
            total: parseFloat(form['debt-total'].value),
            installmentsTotal: parseInt(form['debt-installments'].value) || 1,
            installmentsPaid: 0,
            dueDate: form['debt-due-date'].value, 
            isRecurrent: form['debt-recurrent'].checked 
        });
        renderAll(); form.reset();
        document.getElementById('debt-installments').value = 1;
    });
    
    document.getElementById('add-all-to-calendar-btn').addEventListener('click', () => {
        const unpaid = debts.filter(d => d.installmentsPaid < d.installmentsTotal);
        if (unpaid.length === 0) { openModal('Agenda', '<p>Parabéns! Nenhuma dívida pendente.</p>'); return; }
        const links = unpaid.map(d => `<a href="https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(`Vencimento: ${d.name}`)}&dates=${d.dueDate.replace(/-/g, '')}/${d.dueDate.replace(/-/g, '')}" target="_blank" class="block mb-2 text-blue-600 hover:underline">${d.name} - ${formatDate(d.dueDate)}</a>`).join('');
        openModal('Adicionar Vencimentos à Agenda', `<div><p class="mb-4">Clique nos links abaixo para adicionar cada vencimento:</p>${links}</div>`);
    });

    function renderInvestments() {
        invTableBody.innerHTML = '';
        if (investments.length === 0) { invTableBody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-slate-500">Nenhum investimento cadastrado.</td></tr>`; }
        investments.forEach(inv => {
            const businessDays = calculateBusinessDays(new Date(inv.date), new Date());
            const updatedValue = inv.amount * Math.pow(1 + CDI_DAILY_RATE, businessDays);
            const dailyYield = updatedValue * CDI_DAILY_RATE, monthlyYield = dailyYield * 21;
            invTableBody.insertAdjacentHTML('beforeend', `<tr class="hover:bg-slate-50"><td class="p-4"><div class="font-medium text-slate-800">${inv.name}</div><div class="text-sm text-slate-500">${inv.type} | Aporte: ${formatCurrency(inv.amount)}</div></td><td class="p-4 text-slate-600">${formatDate(inv.date)}</td><td class="p-4 text-green-600 text-right">${formatCurrency(dailyYield)}</td><td class="p-4 text-green-600 text-right">${formatCurrency(monthlyYield)}</td><td class="p-4 font-semibold text-slate-800 text-right">${formatCurrency(updatedValue)}</td><td class="p-4 text-center"><button class="text-red-500 hover:text-red-700 delete-btn" data-id="${inv.id}" title="Excluir Investimento" data-type="investment"><i class="fas fa-trash-alt fa-lg"></i></button></td></tr>`);
        });
        updateInvestmentTotals();
    }
    const updateInvestmentTotals = () => {
        const total = investments.reduce((s, i) => s + i.amount, 0); totalInvestedEl.textContent = formatCurrency(total);
        const updatedTotal = investments.reduce((s, i) => s + (i.amount * Math.pow(1 + CDI_DAILY_RATE, calculateBusinessDays(new Date(i.date), new Date()))), 0);
        totalUpdatedInvestedEl.textContent = formatCurrency(updatedTotal);
    };
    invForm.addEventListener('submit', (e) => {
        e.preventDefault(); const form = e.target;
        investments.push({ id: Date.now(), name: form['inv-name'].value, type: form['inv-type'].value, amount: parseFloat(form['inv-amount'].value), date: form['inv-date'].value });
        renderAll(); form.reset();
    });

    document.body.addEventListener('click', (e) => {
        const target = e.target.closest('button');
        if (!target) return;
        const id = parseInt(target.dataset.id);
        
        if (target.classList.contains('delete-btn')) {
            if (target.dataset.type === 'debt') { debts = debts.filter(d => d.id !== id); } 
            else { investments = investments.filter(i => i.id !== id); }
            renderAll();
        } 
        else if (target.classList.contains('pay-installment-btn')) {
            const debt = debts.find(d => d.id === id);
            if (debt && debt.installmentsPaid < debt.installmentsTotal) {
                debt.installmentsPaid++;
                const isPaidOff = debt.installmentsPaid >= debt.installmentsTotal;

                if (isPaidOff && debt.isRecurrent) {
                    handlePaidRecurrentDebt(debt);
                } else if (!isPaidOff) {
                    const nextDueDate = new Date(debt.dueDate + 'T00:00:00');
                    nextDueDate.setMonth(nextDueDate.getMonth() + 1);
                    const originalDay = new Date(debt.dueDate + 'T00:00:00').getDate();
                    if (nextDueDate.getDate() !== originalDay) { nextDueDate.setDate(0); }
                    debt.dueDate = nextDueDate.toISOString().split('T')[0];
                }
                renderAll();
            }
        }
    });

    modal.addEventListener('click', (e) => {
        if (e.target.id === 'modal' || e.target.closest('#modal-close-btn')) {
            closeModal();
            return;
        }

        const deleteBtn = e.target.closest('.delete-category-btn');
        if (deleteBtn) {
            const name = deleteBtn.dataset.name;
            if (debts.some(d => d.category === name)) {
                openModal('Ação Bloqueada', `Não é possível excluir a categoria "<strong>${name}</strong>" pois ela está sendo usada em uma ou mais dívidas.`);
            } else { 
                categories = categories.filter(c => c.name !== name);
                renderAll();
                renderCategoryManagerInModal();
            }
        }
    });

    modal.addEventListener('submit', (e) => {
        if(e.target.id === 'add-category-form-modal') {
            e.preventDefault();
            const nameInput = document.getElementById('new-cat-name-modal');
            const iconInput = document.getElementById('new-cat-icon-modal');
            const name = nameInput.value;
            const icon = iconInput.value;
            if (name && icon && !categories.some(c => c.name.toLowerCase() === name.toLowerCase())) {
                categories.push({ name, icon, color: `#${Math.floor(Math.random()*16777215).toString(16)}`});
                renderCategorySelect();
                renderCategoryManagerInModal();
                nameInput.value = ''; iconInput.value = '';
            }
        }
    });

    modal.addEventListener('input', (e) => {
         if (e.target.classList.contains('category-color-input')) {
            const cat = categories.find(c => c.name === e.target.dataset.name);
            cat.color = e.target.value; 
            renderAll();
            renderCategoryManagerInModal();
        }
    });

    // Import/Export Logic
    const exportBtn = document.getElementById('export-data-btn');
    const importBtn = document.getElementById('import-data-btn');
    const importFileInput = document.getElementById('import-file-input');

    exportBtn.addEventListener('click', () => {
        const dataStr = JSON.stringify({ categories, debts, investments });
        const dataBlob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'meu-financeiro.json';
        link.click();
        URL.revokeObjectURL(url);
    });

    importBtn.addEventListener('click', () => {
        importFileInput.click();
    });

    importFileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const importedData = JSON.parse(event.target.result);
                if (importedData.categories && importedData.debts && importedData.investments) {
                    categories = importedData.categories;
                    debts = importedData.debts;
                    investments = importedData.investments;
                    renderAll();
                } else {
                    alert('Arquivo JSON inválido.');
                }
            } catch (error) {
                alert('Erro ao ler o arquivo.');
            }
        };
        reader.readAsText(file);
        e.target.value = ''; // Reset input
    });


    const renderAll = () => { 
        renderCategorySelect(); 
        renderDebts(); 
        renderInvestments(); 
        renderCalendar(); 
        saveData();
    };
    
    // Initial Load
    loadData();
    renderAll();
});
</script>

</body>
</html>

